---
output:
  pdf_document:
    includes:
      before_body: TP-title.tex
      in_header: preamble-latex.tex
---  
\centering  

\clearpage  
  
\tableofcontents   

\justify  
\clearpage  

```{r setup, include=FALSE}
options(OutDec = ",", digits = 4)
knitr::opts_chunk$set(echo = TRUE, digits = 4)
```

```{r paquetages, message=FALSE, eval=TRUE, include=FALSE, echo = FALSE}
### Liste des paquetages
liste <-c("magrittr", "derivmkts", "httr","ggplot2")

installation <- liste %in% installed.packages()
if(length(liste[!installation]) > 0) {
  install.packages(liste[!installation], repos = "https://cran.rstudio.com/")
}

lapply(liste, require, character.only = TRUE)

```

# 1. Approximation des paramètres

Le premier paramètre à estimer est la volatilité. Celle-ci est définie par

$$
\hat{\sigma} = \frac{Stdev(ln(S_{t+h}/S_t))}{{h^{1/2}}}.
$$
```{r sigma, echo = FALSE, eval = TRUE}
banque_can <- read.csv("taux_can.csv")


## importation données mensuelles historiques
data_histo <- read.csv("DonnéesTPGRF2(version2).csv")
data_histo <- data_histo[-1, 13]



## moyenne taux banque du canada, mensuelle
r <- mean(banque_can[, 2])/100
r_log <- log(1 + r)

h <- 1/12 # les données sont mensuelles

longeur_donnee <- length(data_histo)

donnee_ln <- numeric(longeur_donnee) # pour le remplir

donnee_ln[1] <- NA

for (i in 2:longeur_donnee){
  (donnee_ln[i] <- log(data_histo[i]/data_histo[i-1]))
}

sig <- sd(donnee_ln[-1])/sqrt(h)
u_quatreper <- exp((r_log*1/4)+sig*sqrt(1/4))
d_quatreper <- exp((r_log*1/4)-sig*sqrt(1/4))
p_quatreper <- (exp(r_log*1/4)-d_quatreper)/(u_quatreper-d_quatreper)

u_52per <- exp((r_log*1/52)+sig*sqrt(1/52))
d_52per <- exp((r_log*1/52)-sig*sqrt(1/52))
p_52per <- (exp(r_log*1/52)-d_52per)/(u_52per-d_52per)
```

Comme les données fournies avec l'énoncé sont mensuelles, on a que $h = 1/12$. La valeur finale de $\hat{\sigma}$ est `r sig*100`%.

La valeur du taux sans risque est estimée grâce à la moyenne des taux d'intérêts effectifs annuels des bons du trésor de chaque mois des cinq dernières années (2019-03 au 2024-02). L'estimation du taux sans risque a pour valeur $r =$ `r r*100`%. Comme le taux est utilisé sous forme continue dans les formules d'arbre binomial, $r$ a une valeur de `r r_log*100`% de façon continue.

Pour construire les arbres binomiaux, les valeurs de $u$, $d$ et $p$ sont nécessaires. Il est également possible de déterminer le portefeuille réplicatif pour chacun des noeuds à l'aide des valeurs de $\Delta$ et $B$. Les formules suivantes permettent d'obtenir ces valeurs

$$
u = e^{(r-\delta)h+\sigma\sqrt{h}},
$$
$$
d = e^{(r-\delta)h-\sigma\sqrt{h}},
$$
$$
p=\frac{e^{rh}-d}{u-d},
$$
$$
\Delta = \frac{f_u - f_d}{U - D} = \frac{f_u - f_d}{S(u-d)},
$$

$$
B = e^{-rh} \bigg( \frac{uf_d - df_u}{u-d} \bigg),
$$
$$
f = \Delta S + B, \text{ où f se définit par C ou D}.
$$

Comme l'énoncé mentionne l'absence de dividendes, on suppose que $\delta = 0$.

Pour l'arbre binomial à 4 périodes, on obtient que $u =$ `r u_quatreper`, $d =$ `r d_quatreper` et $p =$ `r p_quatreper*100`%.

Pour l'arbre binomial à 52 périodes, on obtient que $u =$ `r u_52per`, $d =$ `r d_52per` et $p =$ `r p_52per*100`%.

# 2. Arbres binomiaux

La présente section montre la démarche et les graphiques des arbres binomiaux demandés. La fonction `binomopt` du paquetage `derivmkts` a été grandement utilisée.

## Arbres binomiaux à 4 périodes


```{r code_arbre_1, echo = FALSE, eval = TRUE}
arbre <- function (s, k, v, r, tt, d, nstep, putopt = FALSE, american = TRUE,
                   plotvalues = FALSE, plotarrows = FALSE, drawstrike = TRUE,
                   pointsize = 4, ylimval = c(0, 0), saveplot = FALSE, saveplotfn = "binomialplot.pdf",
                   crr = FALSE, jarrowrudd = FALSE, titles = TRUE, specifyupdn = FALSE,
                   up = 1.5, dn = 0.5, returnprice = FALSE, logy = FALSE)
{
    setylim <- ifelse((sum(ylimval^2) == 0), FALSE, TRUE)
    y <- binomopt(s, k, v, r, tt, d, nstep, american, putopt,
                  specifyupdn, crr, jarrowrudd, up, dn, returnparams = TRUE,
                  returntrees = TRUE)
    h <- tt/nstep
    for (i in c("up", "dn", "p")) assign(i, y$params[i])
    for (i in c("stree", "exertree", "oppricetree", "probtree")) assign(i,
                                                                        y[["i"]])
    nn <- 0:nstep
    payoffmult <- ifelse((putopt), -1, 1)
    stree <- y$stree
    exertree <- y$exertree
    oppricetree <- y$oppricetree
    probtree <- y$probtree
    bondtree <- y$bondtree
    deltatree <- y$deltatree
    plotcolor <- ifelse(exertree, "green3", "red")
    if (saveplot)
        pdf(saveplotfn)
    ylim_default <- c(0, max(stree) * 1.03)
    savepar <- par(no.readonly = TRUE)
    if (logy)
        par(ylog = TRUE)
    plot(rep(nn, nn + 1) * h, stree[stree > 0], ylim = ifelse(c(setylim,
                                                                setylim), ylimval, c(min(stree[stree > 1] - 0.95), max(stree) *
                                                                                         1.03)), col = plotcolor[stree > 0], pch = 21,
         cex = ifelse(stree[stree > 0], sqrt(probtree[stree > 0]) *
                          pointsize, 1), bg = plotcolor[stree > 0],
         xlab = ifelse(titles, "Période binomiale (année)", ""),
         ylab = ifelse(titles, "Prix de l'action ($)", ""),
         main = if (titles) paste(ifelse(putopt, "Option de vente", "Option d'achat"),
                                  ifelse(american, "américaine", "européenne")),
         log = ifelse(logy, "y", ""))

    if (titles)
        mtext(paste0("Prix initial = ", format(s, digits = 3), 
                     ", Prix d'exercice = ",
                     format(k, digits = 3), ", Temps = ", format(tt, digits = 4),
                     ifelse(tt == 1, " an,", " ans,"), " Prix = ",
                     format(oppricetree[1, 1], digits = 5)))
    if (drawstrike)
        abline(h = k, lty=2)
    yoffset <- ifelse(setylim, 0.03 * (ylimval[2] - ylimval[1]),
                      0.03 * max(stree))
    if (plotarrows) {
        for (i in 1:nstep) {
            for (j in 1:i) {
                arrows((i - 1) * h, stree[j, i], c(i, i) * h,
                       c(stree[j, i + 1], stree[j + 1, i + 1]), length = 0.06)
            }
        }
    }
    if (plotvalues) {
        for (i in 1:(nstep + 1)) {
            text((i - 1) * h, stree[1:i, i] + yoffset + 3, format(stree[1:i,
                                                                        i],
                                                                  digits = 3), cex = 0.8)
        }
        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset, format(deltatree[1:i,
                                                                        i],
                                                              digits = 3), cex = 0.8, col="deeppink")
        }

        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset-8, format(bondtree[1:i,
                                                                         i],
                                                                digits = 3), cex = 0.8, col="blue")
        }

        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset-11, format(oppricetree[1:i, i],
                                                                 digits = 3), cex = 0.8, col="purple")
        }
        legend("topleft", c("S", "Delta", "B", "Prix"), bty="n", lty=rep(1, 6),
               col=c("black", "deeppink", "blue", "purple"), cex=0.8)

    }
    if (saveplot)
        dev.off()
    if (returnprice)
        return(oppricetree[1, 1])
}

```


L'évolution du prix du sous-jacent pour l'option de vente européenne avec 4 périodes et un prix d'exercice de 95$ est illustré ci-dessous.

```{r code_arbre_put95, echo = FALSE, include = TRUE, fig.height=8, results='hide'}
arbre(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = FALSE,
      putopt = TRUE, plotvalues = TRUE, plotarrows = TRUE, returnprice = TRUE,
      drawstrike = FALSE)

put95_4p = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = F,
         putopt = T)

```
\begin{center}
\textsf{Figure 1 : Arbre binomial de l'option de vente européenne à 4 périodes}
\end{center}

À l'aide de la Figure 1, il est possible de constater que l'option de vente européenne est levée pour seulement deux prix du sous-jacent, soit les points verts. Les informations pertinentes de l'arbre binomial sont soulevées directement sur la Figure 1. Pour tous les arbres binomiaux présentés dans ce rapport, la taille des cercles est proportionnelle à la probabilité d'atteindre le noeud dans l'arbre.

\newpage
L'évolution du prix du sous-jacent pour l'option d'achat européenne avec 4 périodes avec un prix d'exercice de 110$ est illustré ci-dessous.

```{r code_arbre_call110, echo = FALSE, include = TRUE, fig.height=8, results='hide'}
## option d'achat européenne k = 110, prix initial de l'indice = 100
arbre(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = FALSE,
      putopt = FALSE, plotvalues = TRUE, plotarrows = TRUE, returnprice = TRUE,
      drawstrike = FALSE)

call110_4p = binomopt(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = F,
         putopt = F)

```
\begin{center}
\textsf{Figure 2 : Arbre binomial de l'option d'achat européenne à 52 périodes}
\end{center}

Par l'entremise de la Figure 2, on observe que l'option d'achat européenne est levée pour seulement deux prix du sous-jacent. Les points où l'option est levée sont en vert. Les informations pertinentes de l'arbre binomial sont soulevées directement sur la Figure 2.
\newpage

## Arbres binomiaux à 52 périodes

```{r code52_prix, echo = FALSE, eval = TRUE}
## option de vente européenne avec prix d'exercice de 95, prix initial de l'indice = 100
put95_52p = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 52, american = F,
         putopt = T)

## option d'achat européenne avec prix d'exercice de 110, prix initial de l'indice = 100
call110_52p = binomopt(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0, nstep = 52, american = F,
         putopt = F)

```

Le prix de l'option de vente européenne calculé avec un abre binomial de 52 périodes et un prix d'exercice de 95\$ est de `r put95_52p`\$. En utilisant, encore une fois, un arbre de 52 périodes, le prix de l'option d'achat européenne avec prix d'exercice de 110\$ est `r call110_52p`\$.

```{r opt_asia, echo = FALSE, eval = TRUE}
set.seed(20030811)
call_asia <- arithavgpricecv(100, 110, sig, r_log, 1, 0, m=52, numsim=1000000)[[1]]

put_asia <-putupout(100, 95, sig, r_log, 1, 0, 105)
```


### Option d'achat asiatique
Pour calculer l'option d’achat asiatique sur moyenne arithmétique, la formule est la suivante:
$$C=Max(0;A(T)-k)$$
Où 
$$A(T)= \frac{1}{N} \sum_{i=1}^{N} S_{ih}, \text{ où}$$
$$T : \text{échéance de l'option}$$
$$h : \text{temps entre les périodes}$$
$$N = \frac{T}{h}$$

Contrairement aux options classiques présentées dans les sections précédentes de ce rapport, la valeur à l'échéance dépendera du prix moyen du sous-jacent. Ces options sont donc dépendantes de la trajectoire du prix du sous-jacent, ce qui n'est pas le cas des options classiques. Le fait de prendre une moyenne du prix a comme effet de réduire la volatilité par rapport au prix à l'échance. Plus le nombre d'observations N augmente dans l'option asiatique, plus son prix diminuera.


Les prix des options asiatiques ont été trouvés à l'aide de la fonction `arithavgpricecv` du paquetage `derivmkts`.

Le prix de l'option d'achat arithmétique avec un prix d'exercice de 110\$ est `r call_asia`\$. 

### Option de vente à barrière désactivante
Pour calculer l'option de vente à barrière désactivante, la formule est la suivante :  


$$
P = \max(0, K - S_T) 1_{\max_{0 \leq t \leq T} (S_t) < H}
$$
La valeur à l'échéance d'une option à barrière désactivante dépend du passage ou non de la trajectoire du prix du sous-jacent par la barrière. Si le prix du sous-jacent atteint le prix de la barrière au moins une fois d'ici l'échéance T, l'option sera désactivée. Dans le contexte de ce rapport, comme le prix inital du sous-jacent est inférieur à la barrière, il est question d'une option à barrière désactivante à la hausse.  


Les prix de l'option de vente à barrière désactivante a été trouvé à l'aide de la fonction `putupout` du paquetage `derivmkts`.

Le prix de l'option de vente à barrière désactivante de 105\$ avec un prix d'exercice de 95\$ est `r put_asia`\$. 

\newpage
# 3. Relation du prix de l'option et du prix d'exercice  
## Option d'achat  
On constate la relation du prix à payer pour l'option d'achat européenne présentée
à la section 2, celle avec le modèle 52 périodes et un prix initial de 100$, grâce à la Figure 3 ci-dessous.  

```{r graphique achat 52 periodes, echo = FALSE, include = TRUE, fig.width=9, fig.height=5,results='hide'}
k <- seq(from = 50, to = 250, by = 5)
prix_achat <- sapply(k, function(k) binomopt(s = 100, k = k, v = sig, r = r_log, tt = 1, d = 0, nstep = 52, american = F,
                                        putopt = F, returntrees = T)$price)

data_graph <- data.frame(prix_exercice = k, prix_call = prix_achat)

graph_call <- ggplot(data_graph, aes(x = prix_exercice, y = prix_call)) + geom_line() +
  labs(
    x = "Prix d'exercice ($)",
    y = "Prix de l'option ($)"
  ) +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 12)
  ) + theme_classic()
graph_call

```
\begin{center}
\textsf{Figure 3 : Coût de l'option d'achat en fonction du prix d'exercice}
\end{center}

La Figure 3 illustre une relation inversement proportionnelle entre le prix à payer 
pour l’option d’achat et le prix d’exercice. Ce comportement est attendu : plus 
le prix d’exercice est faible, plus le prix à payer pour l’option sera élevé, car
il est plus avantageux d’acheter l’actif sous-jacent à un prix inférieur que sa valeur 
actuelle. Donc, plus le prix du sous-jacent diminue, plus il y a une augmentation des probabilités que l'option soit levée.  
À l’inverse, un prix d’exercice élevé entraine une diminution du prix de
l'option puisqu’il est moins probable qu’elle soit exercée, car il est moins avantageux 
d’acheter l’actif sous-jacent à un prix supérieur que sa valeur actuelle.   

\newpage
## Option de vente  
On constate la relation du prix à payer pour l'option de vente européenne présentée
à la section 2, celle avec le modèle 52 périodes, grâce à la Figure 4 ci-dessous.  

```{r graphique vente 52 periodes, echo = FALSE, include = TRUE, fig.cap= "Graphique du prix d'une option de vente européenne en fonction du prix d'exercice", fig.width=9, fig.height=5,results='hide'}
k <- seq(from = 0, to = 200, by = 5)
prix_put <- sapply(k, function(k) binomopt(s = 100, k = k, v = sig, r = r_log, tt = 1, d = 0, nstep = 52, american = F,
                                        putopt = T, returntrees = T)$price)

data_graph <- data.frame(prix_exercice = k, prix_put = prix_put)

graph_put <- ggplot(data_graph, aes(x = prix_exercice, y = prix_put)) +
  geom_line() +
  labs(
    x = "Prix d'exercice ($)",
    y = "Prix de l'option ($)"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 12))
graph_put

```
\begin{center}
\textsf{Figure 4 : Coût de l'option de vente en fonction du prix d'exercice}
\end{center}

La Figure 4 illustre une relation directement proportionnelle entre le prix à payer 
pour l'option de vente et le prix d'exercice. Ce comportement est attendu : plus 
le prix d'exercice est élevé, plus il y a de chance que l'option soit exercée. 
En effet, il est plus avantageux de vendre l'actif à un prix supérieur que sa valeur
actuelle, il y a donc plus de chance que l'option de vente soit exercée lorsque le prix 
d'exercice augmente.  
À l'inverse, il est moins avantageux de vendre l'actif à un prix inférieur à sa 
valeur actuelle. Donc, lorsque le prix d'exercice diminue, le prix de l'option 
diminue, car il y a moins de chance qu'elle soit exercée.  

\newpage
# 4. Arbre bionimal de l'option vente américaine  

Avec les mêmes fonctions utilisées pour construire les arbres binomiaux présentés à la section 2, un arbre binomial 4 périodes pour une option de vente américaine a été construit. La figure ci-dessous présente les détails de l'arbre :

```{r code arbre put americain, echo = FALSE, include = TRUE, fig.height=8, results='hide'}

r_log <- log(1+r) 

arbre(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = TRUE,
      putopt = TRUE, plotvalues = TRUE, plotarrows = TRUE, returnprice = TRUE,
      drawstrike = FALSE)

put95_4p_ame = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4, american = T,
         putopt = T)

```
\begin{center}
\textsf{Figure 5 : Arbre binomial de l'option d'achat américaine à 4 périodes}
\end{center}

\newpage

Une première différence entre l'option de vente américaine et l'option de vente européenne (présentée à la section 2) est leur prix d'achat. L'option de vente américaine a un prix d'achat plus élevée que l'option de vente européenne. En effet, le prix de l'option européenne est de `r put95_4p`\$ alors que celui de l'option américaine est `r put95_4p_ame`\$.  Ceci est dû au fait qu'il y a plus de chance que l'option de vente américaine soit levée en raison de la possibilité d'exercer l'option avant l'échéance. Cette différence est refletée dans chacun des noeuds. Effectivement, comme les prix des options sont différents à chacun des noeuds, les paramètres des portefeuilles réplicatifs sont aussi différents.  

Cela introduit la deuxième différence, soit la possibilité que les options américaines soient levées avant l'échéance. Comme il est possible de constater sur la Figure 5, l'option de vente américaine est levée hâtivement à la $3^{e}$ période, tandis que l'option de vente européenne ne peut qu'être levée qu'à l'échéance. Dans le cas de la Figure 5, il est intéressant de lever l'option hâtivement à la $3^{e}$ période, car le prix de l'option, soit 23,44\$, est plus élevé que le prix d'exercice, soit $max(95 - St_t,0) = max(95-71,6,0) = 23,4\$$. Cependant, si l'option américaine n'est pas levée hâtivement, elle sera exercée à l'échéance comme l'option européenne. 

Pour finir, les paramètres $u$, $d$ et $p$ sont les mêmes pour l'arbre européen et américain. Les paramètres sont présentés à la section 1 du présent rapport.


# 5. Modèle de Black-Scholes

La présente section a pour but de montrer les prix des options européennes de la section 2 mais sous l'équation du modèle de Black-Scholes. 

## Option d'achat

L'option d'achat du modèle de Black-Scholes se définit de la façon suivante

$$
C(S,K,\sigma,r,T,\delta) = Se^{-\delta T}N(d_{1}) - Ke^{-rT}N(d_{2}),
$$
Les valeurs de $d_1$ et $d_2$ sont
$$
d_{1} = \frac{ln(\frac{S}{K}) + (r - \delta  + \frac{\sigma^{2}}{2})T}{\sigma\sqrt{T}}
$$
et
$$
d_{2} = d_{1} - \sigma\sqrt{T}.
$$
```{r mod_BS, echo = FALSE, include = TRUE, fig.height=8, results='hide'}

call_BS <- function(s, k, sig, r_log, t, div)
{
  d1 <- (log(s/k) + (r_log - div + sig^2/2)*t)/(sig*sqrt(t))
  d2 <- d1 - sig*sqrt(t)
  s*exp(-div*t)*pnorm(d1) - k*exp(-r_log*t)*pnorm(d2)
}

call_BS110 <- call_BS(100, 110, sig, r_log, 1, 0)

```

Ainsi, la valeur de l'option d'achat est $C(100,110,0.2338,0.02137, 1, 0)$ = `r call_BS110`\$.

## Option de vente
L'option de vente du modèle de Black-Scholes se définit de la façon suivante

$$
P(S,K,\sigma,r,T,\delta) = Ke^{-r T}N(-d_{2}) - Se^{-\delta T}N(-d_{1}),
$$
Les valeurs de $d_1$ et $d_2$ sont définies de la même façon que pour l'option d'achat.

```{r mod_BS_put, echo = FALSE, include = TRUE, fig.height=8, results='hide'}

put_BS <- function(s, k, sig, r_log, t, div)
{
  d1 <- (log(s/k) + (r_log - div + sig^2/2)*t)/(sig*sqrt(t))
  d2 <- d1 - sig*sqrt(t)
  k*exp(-r_log*t)*pnorm(-d2) - s*exp(-div*t)*pnorm(-d1)
}

put_BS95 <- put_BS(100, 95, sig, r_log, 1, 0)

```

Ainsi, la valeur de l'option de vente est $P(100, 95,0.2338,0.02137, 1, 0)$ = `r put_BS95`\$.

## Modèle d'arbre binomial vs Modèle de Black-Scholes
Le modèle de Black-Scholes se veut l'équivalent continu du modèle de l'arbre binomial. C'est-à-dire, il s'agit de l'équivalent d'un arbre binomial avec un nombre infini de périodes dans un intervalle de temps fini.

Ainsi, à partir d'un certain nombre de périodes, le prix de l'option, obtenu avec l'arbre binomial, aura tendance à converger vers un prix obtenu avec la formule de Black-Scholes. 

Il est donc intéressant de comparer les prix des options européennes calculés avec les arbres binomiaux à ceux donnés par le modèle de Black-Scholes. 

On observe que la valeur de l’option d’achat européenne obtenue avec le modèle binomial à 4 périodes, soit `r call110_4p`\$, s'écarte sensiblement de la valeur de l'option d'achat européenne donnée par le modèle de Black-Scholes, soit `r call_BS110`\$.

À l'inverse, lorsqu'on compare le modèle de Black-Scholes avec l'arbre binomiale à 52 périodes, on observe que la valeur de l'option d'achat obtenue avec l'arbre binomial, soit `r call110_52p`\$, converge vers la valeur obtenue avec le modèle de Black-Scholes, soit  `r call_BS110`\$. Cette converge est illustrée sur la Figure 6.




```{r, convergence call, include=T, echo=F, fig.keep='last', message=FALSE,warning=FALSE}
s     <- 100    
k     <- 110     
tt    <- 1     
d     <- 0      


bs_call <- call_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d)

# Boucle sur n pas pour le binomial
n_max       <- 100
binom_prices_call <- sapply(1:n_max, function(n) {
  arbre(
    s           = s,
    k           = k,
    v           = sig,
    r           = r_log,
    tt          = tt,
    d           = d,
    nstep       = n,
    putopt      = FALSE,    
    american    = FALSE,   
    returnprice = TRUE     
  )
})


df <- data.frame(
  nstep    = 1:n_max,
  Binomial = binom_prices_call
)


convergence_call <- ggplot(df, aes(x = nstep, y = Binomial)) +
  geom_line(color = "forestgreen", size = 1) +
  geom_hline(yintercept = bs_call,
             linetype    = "dashed",
             color       = "red",
             size        = 1) +
  annotate("text",
           x     = round(n_max * 0.8),
           y     = bs_call + 0.05,
           label = "Black–Scholes",
           color = "red") +
  annotate("text",
           x     = round(n_max * 0.15),
           y     = 7,
           label = "Arbre binomial",
           color = "forestgreen") +
  labs(
    x     = "Nombre de périodes",
    y     = "Prix de l'option"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
convergence_call
```
\begin{center}
\textsf{Figure 6 : Convergence du prix de l'option d'achat européenne obtenu avec le modèle de l'arbre binomiale vers le prix obtenu avec le modèle de Black-Scholes.}
\end{center}


Ces constats ilustrent bien qu'au fur et à mesure que le nombre de périodes augmente dans l’arbre binomial, le prix calculé de l’option tend à se rapprocher de celui obtenu avec le modèle de Black-Scholes.

Des observations similaires peuvent être faites pour l’option de vente européenne. En effet, on remarque que la valeur de l'option de vente obtenue à partir du modèle binomial à 4 périodes, soit `r put95_4p`\$ s’éloigne sensiblement de celle fournie par le modèle de Black-Scholes, soit `r put_BS95`\$.

À l'inverse, lorsqu'on compare le modèle de Black-Scholes avec l'arbre binomiale à 52 périodes, on observe que la valeur de l'option de vente obtenue avec l'arbre binomial, soit `r put95_52p`\$, converge vers la valeur obtenue avec le modèle de Black-Scholes, soit  `r put_BS95`\$. Cela confirme à nouveau la convergence lorsque le nombre de périodes est suffisamment élevé. De plus, la convergence est illustrée sur la Figue 7.



```{r, convergence vente, include=T, echo=F, fig.keep='last', message=FALSE,warning=FALSE}
s     <- 100    
k     <- 95     
tt    <- 1     
d     <- 0      


bs_put <- put_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d)

# Boucle sur n pas pour le binomial
n_max       <- 100
binom_prices <- sapply(1:n_max, function(n) {
  arbre(
    s           = s,
    k           = k,
    v           = sig,
    r           = r_log,
    tt          = tt,
    d           = d,
    nstep       = n,
    putopt      = TRUE,    
    american    = FALSE,   
    returnprice = TRUE     
  )
})


df <- data.frame(
  nstep    = 1:n_max,
  Binomial = binom_prices
)


convergence <- ggplot(df, aes(x = nstep, y = Binomial)) +
  geom_line(color = "forestgreen", size = 1) +
  geom_hline(yintercept = bs_put,
             linetype    = "dashed",
             color       = "red",
             size        = 1) +
  annotate("text",
           x     = round(n_max * 0.8),
           y     = bs_put + 0.05,
           label = "Black–Scholes",
           color = "red") +
  annotate("text",
           x     = round(n_max * 0.15),
           y     = 7,
           label = "Arbre binomial",
           color = "forestgreen") +
  labs(x     = "Nombre de périodes",
    y     = "Prix de l'option"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
convergence
```
\begin{center}
\textsf{Figure 7 : Convergence du prix de l'option de vente européenne obtenu avec le modèle de l'arbre binomiale vers le prix obtenu avec le modèle de Black-Scholes.}
\end{center}
  
À la section 3, il avait été démontré que la relation entre le prix d'exercice et le prix à payer pour une option d'achat européenne était inversement proportionnelle, pour une modèle d'arbre binomial (voir la Figure 3). Il est possible d'émettre le même constat avec le modèle Black-Scholes. Il est possible de constater cette affirmation par la Figure 8. C'est le résultat attendu puisque le modèle Black-Scholes est l'équivalent continu du modèle d'arbre binomial.  


```{r, echo = FALSE, fig.width=5, fig.height=3}
k <- seq(from = 50, to = 250, by = 5)
prix_achat_BS <- sapply(k, function(k) call_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d))

data_graph_BS <- data.frame(prix_exercice = k, prix_call_BS = prix_achat_BS)

graph_call_BS <- ggplot(data_graph_BS, aes(x = prix_exercice, y = prix_call_BS)) + geom_line() +
  labs(
    x = "Prix d'exercice ($)",
    y = "Prix de l'option ($)"
  ) +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 12)
  ) + theme_classic()
graph_call_BS
```

\begin{center}
\textsf{Figure 8 : Coût de l'option d'achat européenne avec le modèle Black-Scholes en fonction du prix d'exercie}
\end{center}

Il avait aussi été affirmé que le prix d'achat d'une option de vente européenne et le prix d'exercice avait une relation directement proportionnelle. Il est, encore une fois, posssible d'émettre le même constat avec le modèle Black-Scholes. Cette relation est illustrée dans la Figure 9.  



```{r, echo= FALSE, fig.width=5, fig.height=3}
k <- seq(from = 0, to = 200, by = 5)
prix_put_BS <- sapply(k, function(k) put_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d))

data_graph_BS <- data.frame(prix_exercice = k, prix_put_BS = prix_put_BS)

graph_put_BS <- ggplot(data_graph_BS, aes(x = prix_exercice, y = prix_put_BS)) +
  geom_line() +
  labs(
    x = "Prix d'exercice ($)",
    y = "Prix de l'option ($)"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 12))
graph_put_BS

```
\begin{center}
\textsf{Figure 9 : Coût de l'option de vente européenne avec le modèle Black-Scholes en fonction du prix d'exercice}
\end{center}
\newpage


# Annexe
```{r, eval=F}
#### Liste des paquetages et installation si nécessaire ####
liste <-c("magrittr", "derivmkts", "httr","ggplot2")

installation <- liste %in% installed.packages()
if(length(liste[!installation]) > 0) {
    install.packages(liste[!installation], repos = "https://cran.rstudio.com/")
}

lapply(liste, require, character.only = TRUE)

#### Fonction qui permet d'illustrer les arbres binomiaux ####
arbre <- function (s, k, v, r, tt, d, nstep, putopt = FALSE, american = TRUE,
                   plotvalues = FALSE, plotarrows = FALSE, drawstrike = TRUE,
                   pointsize = 4, ylimval = c(0, 0), saveplot = FALSE,
                   saveplotfn = "binomialplot.pdf",
                   crr = FALSE, jarrowrudd = FALSE, titles = TRUE,
                   specifyupdn = FALSE,
                   up = 1.5, dn = 0.5, returnprice = FALSE, logy = FALSE)
{
    setylim <- ifelse((sum(ylimval^2) == 0), FALSE, TRUE)
    y <- binomopt(s, k, v, r, tt, d, nstep, american, putopt,
                  specifyupdn, crr, jarrowrudd, up, dn, returnparams = TRUE,
                  returntrees = TRUE)
    h <- tt/nstep
    for (i in c("up", "dn", "p")) assign(i, y$params[i])
    for (i in c("stree", "exertree", "oppricetree", "probtree")) assign(i,
                                                                     y[["i"]])
    nn <- 0:nstep
    payoffmult <- ifelse((putopt), -1, 1)
    stree <- y$stree
    exertree <- y$exertree
    oppricetree <- y$oppricetree
    probtree <- y$probtree
    bondtree <- y$bondtree
    deltatree <- y$deltatree
    plotcolor <- ifelse(exertree, "green3", "red")
    if (saveplot)
        pdf(saveplotfn)
    ylim_default <- c(0, max(stree) * 1.03)
    savepar <- par(no.readonly = TRUE)
    if (logy)
        par(ylog = TRUE)
    plot(rep(nn, nn + 1) * h, stree[stree > 0], ylim = ifelse(c(setylim,
       setylim), ylimval,c(min(stree[stree > 1] - 0.95), max(stree) * 1.03)),
                                        col = plotcolor[stree > 0], pch = 21,
         cex = ifelse(stree[stree > 0], sqrt(probtree[stree > 0]) *
                          pointsize, 1), bg = plotcolor[stree > 0],
         xlab = ifelse(titles, "Période binomiale (année)", ""),
         ylab = ifelse(titles, "Prix de l'action ($)", ""),
         main = if (titles) paste(ifelse(putopt, "Option de vente",
                                         "Option d'achat"),
                                  ifelse(american, "américaine", "européenne")),
                                            log = ifelse(logy, "y", ""))

    if (titles)
        mtext(paste0("Prix initial = ", format(s, digits = 3),
                                ", Prix d'exercice = ",
                    format(k, digits = 3), ", Temps = ", format(tt, digits = 4),
                    ifelse(tt == 1, " an,", " ans,"), " Prix = ",
                    format(oppricetree[1, 1], digits = 5)))
    if (drawstrike)
        abline(h = k, lty=2)
    yoffset <- ifelse(setylim, 0.03 * (ylimval[2] - ylimval[1]),
                      0.03 * max(stree))
    if (plotarrows) {
        for (i in 1:nstep) {
            for (j in 1:i) {
                arrows((i - 1) * h, stree[j, i], c(i, i) * h,
                       c(stree[j, i + 1], stree[j + 1, i + 1]), length = 0.06)
            }
        }
    }
    if (plotvalues) {
        for (i in 1:(nstep + 1)) {
            text((i - 1) * h, stree[1:i, i] + yoffset + 3, format(stree[1:i, i],
                                                      digits = 3), cex = 0.8)
        }
        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset, format(deltatree[1:i, i],
                                        digits = 3), cex = 0.8, col="deeppink")
        }

        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset-8, format(bondtree[1:i,
                                                                         i],
                                            digits = 3), cex = 0.8, col="blue")
        }

        for (i in 1:(nstep)) {
            text((i - 1) * h, stree[1:i, i] + yoffset-11, format(oppricetree[1:i,
                                                                             i],
                                          digits = 3), cex = 0.8, col="purple")
        }
        legend("topleft", c("S", "Delta", "B", "Prix"), bty="n", lty=rep(1, 6),
               col=c("black", "deeppink", "blue", "purple"), cex=0.8)

    }
    if (saveplot)
        dev.off()
    if (returnprice)
        return(oppricetree[1, 1])
}


#### 1. Approximation des paramètres ####
## importation des données pour approximer le taux sans risque
banque_can <- read.csv("taux_can.csv")

## importation des données mensuelles historiques
data_histo <- read.csv("DonnéesTPGRF2(version2).csv")
data_histo <- data_histo[-1, 13]

## moyenne taux banque du canada, base effectif annuel
r <- mean(banque_can[, 2])/100
## convertir le taux effectif annuel en taux composé continuellement
r_log <- log(1 + r)

h <- 1/12 # les données historiques sont mensuelles

## approximation de la voltilité
# création d'un vecteur
longeur_donnee <- length(data_histo)

donnee_ln <- numeric(longeur_donnee) # pour le remplir

donnee_ln[1] <- NA

# remplir le vecteur
for (i in 2:longeur_donnee){
    (donnee_ln[i] <- log(data_histo[i]/data_histo[i-1]))
}

# appliquation de la formule pour obtenir l'approximation de la volatilité
sig <- sd(donnee_ln[-1])/sqrt(h)

## Paramètre : u, d, et p pour l'arbre binomial à 4 périodes
u_quatreper <- exp((r_log*1/4)+sig*sqrt(1/4))
d_quatreper <- exp((r_log*1/4)-sig*sqrt(1/4))
p_quatreper <- (exp(r_log*1/4)-d_quatreper)/(u_quatreper-d_quatreper)

## Paramètre : u, d, et p pour l'arbre binomial à 52 périodes
u_52per <- exp((r_log*1/52)+sig*sqrt(1/52))
d_52per <- exp((r_log*1/52)-sig*sqrt(1/52))
p_52per <- (exp(r_log*1/52)-d_52per)/(u_52per-d_52per)


#### 2. Arbres binomiaux ####
### Arbres binomiaux à 4 périodes ###
## Option de vente européenne
# Illustration de l'arbre de l'option de vente européenne
arbre(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4,
      american = FALSE, putopt = TRUE, plotvalues = TRUE, plotarrows = TRUE,
                    returnprice = TRUE,drawstrike = FALSE)
# Mettre le prix dans un objet pour pouvoir l'utiliser dans le texte
put95_4p = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0,
                                nstep = 4, american = F, putopt = T)

## Option d'achat européenne
# Illustration de l'arbre de l'option d'achat européenne
arbre(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0, nstep = 4,
      american = FALSE, putopt = FALSE, plotvalues = TRUE, plotarrows = TRUE,
                        returnprice = TRUE, drawstrike = FALSE)
# Mettre le prix dans un objet pour pouvoir l'utiliser dans le texte
call110_4p = binomopt(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0,
                      nstep = 4, american = F, putopt = F)


### Arbres binomiaux à 52 périodes ###
## Prix option de vente européenne
put95_52p = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0,
                     nstep = 52, american = F, putopt = T)

## Prix option d'achat européenne
call110_52p = binomopt(s = 100, k = 110, v = sig, r = r_log, tt = 1, d = 0,
                       nstep = 52, american = F, putopt = F)


## Prix option d'achat asiatique
set.seed(20030811)
call_asia <- arithavgpricecv(100, 110, sig, r_log, 1, 0, m=52,
                                                    numsim=1000000)[[1]]

## Prix option de vente à barrière désactivante
put_asia <-putupout(100, 95, sig, r_log, 1, 0, 105)


#### 3. Relation du prix de l'option et du prix d'exercice ####
## Option d'achat
# prix d'exercice pour lequel on veut calculer le prix de l'option
k <- seq(from = 50, to = 250, by = 5)
# fonction pour calculer le prix de l'option
prix_achat <- sapply(k, function(k) binomopt(s = 100, k = k, v = sig, r = r_log,
                                        tt = 1, d = 0, nstep = 52, american = F,
                                             putopt = F, returntrees = T)$price)
# code pour faire le graphique
data_graph <- data.frame(prix_exercice = k, prix_call = prix_achat)

graph_call <- ggplot(data_graph, aes(x = prix_exercice, y = prix_call)) +
    geom_line() +
    labs(
        x = "Prix d'exercice ($)",
        y = "Prix de l'option ($)"
    ) +
    theme(
        plot.title = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 12)
    ) + theme_classic()
# afficher le graphique
graph_call

## Option de vente
# prix d'exercice pour lequel on veut calculer le prix de l'option
k <- seq(from = 0, to = 200, by = 5)
# fonction pour calculer le prix de l'option
prix_put <- sapply(k, function(k) binomopt(s = 100, k = k, v = sig, r = r_log,
                                        tt = 1, d = 0, nstep = 52, american = F,
                                           putopt = T, returntrees = T)$price)
# code pour faire le graphique
data_graph <- data.frame(prix_exercice = k, prix_put = prix_put)

graph_put <- ggplot(data_graph, aes(x = prix_exercice, y = prix_put)) +
    geom_line() +
    labs(
        x = "Prix d'exercice ($)",
        y = "Prix de l'option ($)"
    ) +
    theme_classic() +
    theme(
        plot.title = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 12))
# afficher le graphique
graph_put


#### 4. Abre binomial de l'option de vente américaine ####
## Illustration de l'arbre
arbre(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0, nstep = 4,
      american = TRUE, putopt = TRUE, plotvalues = TRUE, plotarrows = TRUE,
                    returnprice = TRUE, drawstrike = FALSE)
## prix de l'option afin de pouvoir l'utiliser dans le rapport
put95_4p_ame = binomopt(s = 100, k = 95, v = sig, r = r_log, tt = 1, d = 0,
                        nstep = 4, american = T, putopt = T)

#### 5. Modèle de Black-Scholes ####
## Option d'achat
call_BS <- function(s, k, sig, r_log, t, div)
{
    d1 <- (log(s/k) + (r_log - div + sig^2/2)*t)/(sig*sqrt(t))
    d2 <- d1 - sig*sqrt(t)
    s*exp(-div*t)*pnorm(d1) - k*exp(-r_log*t)*pnorm(d2)
}
# Prix
call_BS110 <- call_BS(100, 110, sig, r_log, 1, 0)

## Option de vente
put_BS <- function(s, k, sig, r_log, t, div)
{
    d1 <- (log(s/k) + (r_log - div + sig^2/2)*t)/(sig*sqrt(t))
    d2 <- d1 - sig*sqrt(t)
    k*exp(-r_log*t)*pnorm(-d2) - s*exp(-div*t)*pnorm(-d1)
}
# Prix
put_BS95 <- put_BS(100, 95, sig, r_log, 1, 0)


## Comparaison entre le modèle de l'arbre binomial et le modèle de Black-Scholes
# code pour montrer la converge du modèle de l'arbre binomial et le modèle de
# Black-Scholes pour l'option d'achat
s     <- 100
k     <- 110
tt    <- 1
d     <- 0


bs_call <- call_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d)

# Boucle sur n pas pour le binomial
n_max       <- 100
binom_prices_call <- sapply(1:n_max, function(n) {
    arbre(
        s           = s,
        k           = k,
        v           = sig,
        r           = r_log,
        tt          = tt,
        d           = d,
        nstep       = n,
        putopt      = FALSE,
        american    = FALSE,
        returnprice = TRUE
    )
})


df <- data.frame(
    nstep    = 1:n_max,
    Binomial = binom_prices_call
)


convergence_call <- ggplot(df, aes(x = nstep, y = Binomial)) +
    geom_line(color = "forestgreen", size = 1) +
    geom_hline(yintercept = bs_call,
               linetype    = "dashed",
               color       = "red",
               size        = 1) +
    annotate("text",
             x     = round(n_max * 0.8),
             y     = bs_call + 0.05,
             label = "Black–Scholes",
             color = "red") +
    labs(
        x     = "Nombre de périodes",
        y     = "Prix de l'option"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
convergence_call


# code pour montrer la converge du modèle de l'arbre binomial et le modèle de
# Black-Scholes pour l'option d'achat
s     <- 100
k     <- 95
tt    <- 1
d     <- 0


bs_put <- put_BS(s = s, k = k, sig = sig, r_log = r_log, t = tt, div = d)

# Boucle sur n pas pour le binomial
n_max       <- 100
binom_prices <- sapply(1:n_max, function(n) {
    arbre(
        s           = s,
        k           = k,
        v           = sig,
        r           = r_log,
        tt          = tt,
        d           = d,
        nstep       = n,
        putopt      = TRUE,
        american    = FALSE,
        returnprice = TRUE
    )
})


df <- data.frame(
    nstep    = 1:n_max,
    Binomial = binom_prices
)


convergence <- ggplot(df, aes(x = nstep, y = Binomial)) +
    geom_line(color = "forestgreen", size = 1) +
    geom_hline(yintercept = bs_put,
               linetype    = "dashed",
               color       = "red",
               size        = 1) +
    annotate("text",
             x     = round(n_max * 0.8),
             y     = bs_put + 0.05,
             label = "Black–Scholes",
             color = "red") +
    labs(x     = "Nombre de périodes",
         y     = "Prix de l'option"
    ) +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5))
convergence


# coût de l'option d'achat européenne en fonction du prix d'exercice
# avec le modèle de Black-Scholes
k <- seq(from = 50, to = 250, by = 5)
prix_achat_BS <- sapply(k, function(k) call_BS(s = s, k = k, sig = sig,
                                               r_log = r_log, t = tt, div = d))

data_graph_BS <- data.frame(prix_exercice = k, prix_call_BS = prix_achat_BS)

graph_call_BS <- ggplot(data_graph_BS, aes(x = prix_exercice, y = prix_call_BS))
    + geom_line() +
    labs(
        x = "Prix d'exercice ($)",
        y = "Prix de l'option ($)"
    ) +
    theme(
        plot.title = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 12)
    ) + theme_classic()
graph_call_BS

# coût de l'option de vente européenne en fonction du prix d'exercice
# avec le modèle de Black-Scholes
k <- seq(from = 0, to = 200, by = 5)
prix_put_BS <- sapply(k, function(k) put_BS(s = s, k = k, sig = sig,
                                            r_log = r_log, t = tt, div = d))

data_graph_BS <- data.frame(prix_exercice = k, prix_put_BS = prix_put_BS)

graph_put_BS <- ggplot(data_graph_BS, aes(x = prix_exercice, y = prix_put_BS)) +
    geom_line() +
    labs(
        x = "Prix d'exercice ($)",
        y = "Prix de l'option ($)"
    ) +
    theme_classic() +
    theme(
        plot.title = element_text(size = 12, face = "bold"),
        axis.title = element_text(size = 12))
graph_put_BS

```

